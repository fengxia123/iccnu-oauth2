<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Iccnu-oauth2 : iccnu的oauth2认证服务说明文档">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Iccnu-oauth2</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/ccnuyan/iccnu-oauth2">View on GitHub</a>

          <h1 id="project_title">Iccnu-oauth2</h1>
          <h2 id="project_tagline">iccnu的oauth2认证服务说明文档</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/ccnuyan/iccnu-oauth2/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/ccnuyan/iccnu-oauth2/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p><a href="http://ccnuyan.github.io/iccnu-oauth2">http://ccnuyan.github.io/iccnu-oauth2</a></p>

<h1>
<a id="iccnu-oauth2-authentication-flow-instruction" class="anchor" href="#iccnu-oauth2-authentication-flow-instruction" aria-hidden="true"><span class="octicon octicon-link"></span></a>ICCNU Oauth2 Authentication Flow Instruction</h1>

<hr>

<h2>
<a id="before-you-begin" class="anchor" href="#before-you-begin" aria-hidden="true"><span class="octicon octicon-link"></span></a>Before You Begin</h2>

<p>这里是租户应用的调用认证主站 OAuth2 的认证服务的认证流程。这个文档给租户应用的开发者参考。</p>

<p>作为应用的开发者，你需要针对应用的不同类型，对需要采用的认证流程进行选择。B/S应用需要参考Authorization Code Grant Flow，C/S应用需要参考Resource Owner Password Credentials Grant Flow。</p>

<p>认证流程结束后，租户应用需要根据自己的应用是否已上线并存在用户群体，继续创建新用户或绑定已有账户的登录流程。</p>

<hr>

<h4>
<a id="1租户为bs应用" class="anchor" href="#1%E7%A7%9F%E6%88%B7%E4%B8%BAbs%E5%BA%94%E7%94%A8" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.租户为B/S应用</h4>

<p>需要参考 Authorization Code Grant Flow，用户在认证站点登录并跳转至您的应用后，应提示用户绑定已有账户或直接创建新用户，后进入登录状态。</p>

<h4>
<a id="2租户为cs应用" class="anchor" href="#2%E7%A7%9F%E6%88%B7%E4%B8%BAcs%E5%BA%94%E7%94%A8" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.租户为C/S应用</h4>

<p>需要参考 Resource Owner Password Credentials Grant Flow，用户登录至您的应用后，应提示用户绑定已有账户或直接创建新用户，后进入登录状态。</p>

<h2>
<a id="1-租户为bs应用-使用-authorization-code-grant-flow-认证" class="anchor" href="#1-%E7%A7%9F%E6%88%B7%E4%B8%BAbs%E5%BA%94%E7%94%A8-%E4%BD%BF%E7%94%A8-authorization-code-grant-flow-%E8%AE%A4%E8%AF%81" aria-hidden="true"><span class="octicon octicon-link"></span></a>1 租户为B/S应用: 使用 Authorization Code Grant Flow 认证</h2>

<h4>
<a id="使用先决条件" class="anchor" href="#%E4%BD%BF%E7%94%A8%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用先决条件</h4>

<ol>
<li><p>你的用户需要现在ICCNU上注册为用户。</p></li>
<li><p>你需要将你的应用申请成为ICCNU认证服务的租户。</p></li>
</ol>

<p>申请成为ICCNU认证服务的租户时，租户应用需要为认证站点管理员提供的信息包括：</p>

<p><strong>回调地址</strong> "redirectURI" : "http://localhost:8080/account/login"</p>

<p><strong>租户应用Id</strong> "id" : "code_test"</p>

<p><strong>租户应用密码</strong> "secret" : *****</p>

<p><strong>主页地址</strong> "homeURI" : "http://localhost:8080/"</p>

<p><strong>租户应用名</strong> "name" : "测试应用名1"</p>

<p><strong>租户应用描述</strong> "description" : "这里是测试应用1的描述信息"</p>

<p><strong>认证类型</strong> "authType" : "code"</p>

<p>其中，回调地址、租户应用Id及租户应用密码为Authorization Code Grant Flow认证流程中需要用到的必须字段; 主页地址，租户应用名, 租户应用描述为显示给用户的字段，不是必须的；认证类型在Authorization Code Grant Flow中固定为"Code"。   </p>

<h4>
<a id="认证流程" class="anchor" href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>认证流程</h4>

<p>1 用户点击租户应用网页上的“使用ICCNU账户登录”时，携带租户注册参数（包括回调地址，租户应用Id，认证类型等）跳转到认证页面。</p>

<p>2.1 用户登录后，认证页面呈现你的应用信息及用户个人信息，用户授权租户应用（用户授权租户、表示用户允许租户应用通过获得到的AccessToken访问认证主站的服务，包括网盘服务，资源服务等，获得到用户的资源）之后，携带code跳转回你的应用的回调页面。</p>

<p>2.2 租户应用回调页面在处理逻辑中，携带code及租户的信息（包括回调地址，租户应用Id，租户应用密码，认证类型）及申请访问的服务域（暂为全域）等，调用认证站点的token服务，得到用户的AccessToken。</p>

<p>3 租户应用通过AccessToken调用认证站点的Me服务，得到用户的认证信息，认证流程结束。</p>

<p>此时租户应用已经知道调用认证站点ICCNU登录的用户的基本信息，可以继续租户应用自己的业务（绑定已存在的本地用户或者根据登录信息创建用户等等）。</p>

<h2>
<a id="2-租户为cs应用-使用-resource-owner-password-credentials-grant-flow-认证" class="anchor" href="#2-%E7%A7%9F%E6%88%B7%E4%B8%BAcs%E5%BA%94%E7%94%A8-%E4%BD%BF%E7%94%A8-resource-owner-password-credentials-grant-flow-%E8%AE%A4%E8%AF%81" aria-hidden="true"><span class="octicon octicon-link"></span></a>2 租户为C/S应用: 使用 Resource Owner Password Credentials Grant Flow 认证</h2>

<h4>
<a id="使用先决条件-1" class="anchor" href="#%E4%BD%BF%E7%94%A8%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用先决条件</h4>

<ol>
<li><p>你的用户需要现在ICCNU上注册为用户。</p></li>
<li><p>你需要将你的应用申请成为ICCNU认证服务的租户。</p></li>
</ol>

<p>申请成为ICCNU认证服务的租户时，租户应用需要为认证站点管理员提供的信息包括：</p>

<p><strong>租户应用Id</strong> "id" : "code_test"</p>

<p><strong>租户应用密码</strong> "secret" : *****</p>

<p><strong>主页地址 "homeURI"</strong> : "http://localhost:8080/"</p>

<p><strong>租户应用名</strong> "name" : "测试应用名1"</p>

<p><strong>租户应用描述</strong> "description" : "这里是测试应用1的描述信息"</p>

<p><strong>认证类型</strong> "authType" : "resource_owner"</p>

<p>其中，租户应用Id及租户应用密码为Resource Owner Password Credentials Grant Flow认证流程中需要用到的必须字段; 主页地址，租户应用名, 租户应用描述为显示给用户的字段，不是必须的；认证类型在Resource Owner Password Credentials Grant Flow中固定为"resource_owner"。   </p>

<p>C/S应用并不是在浏览器中进行认证流程，所以不需要提供回调地址字段。</p>

<h4>
<a id="认证流程-1" class="anchor" href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>认证流程</h4>

<p>1 用户点击客户端的“使用ICCNU账户登录”时，输入在认证站点上注册的用户名与密码。</p>

<p>2 客户端在后台携带用户输入的用户名与密码及租户的信息（包括回调地址，租户应用Id，租户应用密码，认证类型）及申请访问的服务域（暂为全域）等，调用认证站点的token服务，得到用户的AccessToken。</p>

<p>3 租户应用通过AccessToken调用认证站点的Me服务，得到用户的认证信息，认证流程结束。</p>

<p>此时租户应用已经知道登录用户的基本信息，可以继续租户应用自己的业务（绑定已存在的本地用户或者根据登录信息创建用户等等）。</p>

<p>PS: B/S站点亦可以使用 Resource Owner Password Credentials Grant, 但是不建议这样做。</p>

<h2>
<a id="参考" class="anchor" href="#%E5%8F%82%E8%80%83" aria-hidden="true"><span class="octicon octicon-link"></span></a>参考</h2>

<p>Authorization Code Grant
<a href="https://tools.ietf.org/html/rfc6749#section-4.1">https://tools.ietf.org/html/rfc6749#section-4.1</a></p>

<p>Resource Owner Password Credentials Grant
<a href="https://tools.ietf.org/html/rfc6749#section-4.3">https://tools.ietf.org/html/rfc6749#section-4.3</a></p>

<h2>
<a id="包中的内容" class="anchor" href="#%E5%8C%85%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9" aria-hidden="true"><span class="octicon octicon-link"></span></a>包中的内容</h2>

<p><strong>dot net BS Authorization Code Grant：</strong>dot net B/S 例子 (认证流程见附2)</p>

<p><strong>dot net CS Resource Owner Password Credentials Grant：</strong>dot net C/S 例子</p>

<p><strong>node.js BS Authorization Code Grant：</strong>node.js B/S 例子</p>

<h2>
<a id="附1-各服务调用地址传参方式等继续更新" class="anchor" href="#%E9%99%841-%E5%90%84%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E5%9C%B0%E5%9D%80%E4%BC%A0%E5%8F%82%E6%96%B9%E5%BC%8F%E7%AD%89%E7%BB%A7%E7%BB%AD%E6%9B%B4%E6%96%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>附1 各服务调用地址（传参方式等继续更新）：</h2>

<p><strong>认证站点:</strong> <a href="http://www.iccnu.net/">http://www.iccnu.net/</a></p>

<p><strong>认证页面:</strong> <a href="http://www.iccnu.net/oauth2/authorize">http://www.iccnu.net/oauth2/authorize</a></p>

<p>(租户应用页面上在点击 使用ICCNU账户登录 时，需要重定向至的地址)</p>

<p><strong>AccessToken API End Point:</strong> <a href="http://www.iccnu.net/api/oauth2/token">http://www.iccnu.net/api/oauth2/token</a></p>

<p>(租户应用在得到Code后，需要使用Code到主站上获取已认证用户的AccessToken，这是跟据Code获取AccessToken的服务地址)</p>

<p><strong>Me API End Point:</strong> <a href="http://www.iccnu.net/api/oauth2/me">http://www.iccnu.net/api/oauth2/me</a></p>

<p>(租户应用在得到AccessToken后，根据AccessToken获得用户认证信息的服务地址)</p>

<h2>
<a id="附2-认证流程样例对照" class="anchor" href="#%E9%99%842-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E6%A0%B7%E4%BE%8B%E5%AF%B9%E7%85%A7" aria-hidden="true"><span class="octicon octicon-link"></span></a>附2 认证流程样例对照</h2>

<p>土巴兔利用新浪微博OAuth2服务认证的业务流程 与 dot net B/S例子中租户应用利用ICCNUOAuth2服务认证的业务流程 对照</p>

<p>step 1 土巴兔/租户应用登录，重定向至认证站点</p>

<p><img src="https://raw.githubusercontent.com/ccnuyan/iccnu-oauth2/master/imgs/tu01.jpg" alt=""></p>

<p><img src="https://raw.githubusercontent.com/ccnuyan/iccnu-oauth2/master/imgs/tenant01.jpg" alt=""></p>

<p>step 2 用户在新浪微博/ICCNU上登陆，授权土巴兔/租户应用获取认证信息，然后重定向至土巴兔/租户应用站点</p>

<p><img src="https://raw.githubusercontent.com/ccnuyan/iccnu-oauth2/master/imgs/tu02.jpg" alt=""></p>

<p><img src="https://raw.githubusercontent.com/ccnuyan/iccnu-oauth2/master/imgs/tenant02.jpg" alt=""></p>

<p>step 3 土巴兔/租户站点获取到用户的认证信息，认证结束，土巴兔/租户站点继续其自己的业务</p>

<p>从图中可以看见，由于土巴兔有其自己的用户，所以土巴兔可以让已有土巴兔账户的用户选择绑定已有的账户；若使用微博认证服务登录的用户原来并没有在土巴兔上注册过，则选择跳过此步，可以直接根据微博认证服务返回的认证信息创建新的账户。</p>

<p><img src="https://raw.githubusercontent.com/ccnuyan/iccnu-oauth2/master/imgs/tu03.jpg" alt=""></p>

<p>而在dot net B/S例子中，租户应用直接根据返回的认证信息创建了新的用户
<img src="https://raw.githubusercontent.com/ccnuyan/iccnu-oauth2/master/imgs/tenant03.jpg" alt=""></p>

<h2>
<a id="附3-联系方式" class="anchor" href="#%E9%99%843-%E8%81%94%E7%B3%BB%E6%96%B9%E5%BC%8F" aria-hidden="true"><span class="octicon octicon-link"></span></a>附3 联系方式</h2>

<p>QQ83000710 严中华</p>

<h2>
<a id="附4-api--http-context" class="anchor" href="#%E9%99%844-api--http-context" aria-hidden="true"><span class="octicon octicon-link"></span></a>附4 API &amp; http context</h2>

<h3>
<a id="1-redirect-full-uri-example" class="anchor" href="#1-redirect-full-uri-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>1 redirect full uri example</h3>

<pre><code>http://www.iccnu.net/oauth2/authorize?client_id=code_test&amp;redirect_uri=http:%2F%2Flocalhost:8080%2FAccount%2FLogin&amp;state=-0Fs7e5Pj4TGr0xGK_sqSQ&amp;response_type=code
</code></pre>

<h3>
<a id="1-exchage-code-for-token" class="anchor" href="#1-exchage-code-for-token" aria-hidden="true"><span class="octicon octicon-link"></span></a>1 exchage code for token</h3>

<p>请求：</p>

<p>POST <a href="http://www.iccnu.net/api/oauth2/token">http://www.iccnu.net/api/oauth2/token</a> HTTP/1.1</p>

<p>Authorization: Basic Y29kZV90ZXN0OmNvZGVfdGVzdA==</p>

<p>请求Body</p>

<pre><code>code=Zsd7aihG4qVD0771&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Faccount%2Flogin&amp;grant_type=authorization_code
</code></pre>

<p>响应
HTTP/1.1 200 OK</p>

<p>响应Body</p>

<pre><code>{
"access_token":"[token]",
"token_type":"Bearer"
}
</code></pre>

<h3>
<a id="2-get-user-info-by-token" class="anchor" href="#2-get-user-info-by-token" aria-hidden="true"><span class="octicon octicon-link"></span></a>2 get user info by token</h3>

<p>请求：
GET <a href="http://www.iccnu.net/api/oauth2/me">http://www.iccnu.net/api/oauth2/me</a> HTTP/1.1</p>

<p>Authorization: Bearer [token]</p>

<p>响应
HTTP/1.1 200 OK</p>

<p>响应Body</p>

<pre><code>{
"_id":"55a5b5e95d0054010020d313",
"rootDirectory":"55a5b5e95d0054010020d314",
"displayName":"starcyan",
"provider":"starc",
"username":"yan_starc",
"__v":0,
"created":"2015-07-15T01:22:49.394Z",
"roles":["user"],
"email":"yan@starc.com.cn",
"lastName":"yan",
"firstName":"starc"
}
</code></pre>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Iccnu-oauth2 maintained by <a href="https://github.com/ccnuyan">ccnuyan</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
